<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>566ä»Šå¤©åƒä»€ä¹ˆ</title>
    
    <link rel="manifest" href="manifest.json?v=888">
    <meta name="theme-color" content="#fff0f5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å®å®æ‰‹å¸">
    <link rel="apple-touch-icon" href="https://moonlitsilveriver.github.io/my-food-book/icon.png">
    
    <style>
        /* === ğŸ¬ åŸºç¡€è°ƒè‰²ç›˜ === */
        :root { 
            --primary: #ff80ab; --primary-dark: #f06292;
            --bg-color: #fff0f5; --card-bg: #ffffff;
            --text: #5d4037; --accent: #ffb74d; --danger: #ef9a9a;
            --safe: #4fc3f7;
            --fridge-bg: #e1f5fe; --fridge-border: #81d4fa;
            --zone-bg: rgba(255,255,255,0.6);
        }

        body { 
            font-family: "YouYuan", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#f8bbd0 2px, transparent 2px);
            background-size: 20px 20px;
            color: var(--text); margin: 0; padding: 20px; 
            min-height: 100vh; overflow-x: hidden; 
            -webkit-tap-highlight-color: transparent;
            /* ç¦æ­¢é•¿æŒ‰é€‰ä¸­æ–‡æœ¬ï¼Œä¸ºäº†æ‹–æ‹½ä½“éªŒ */
            user-select: none; -webkit-user-select: none;
        }
        
        /* å¸ƒå±€å®¹å™¨ */
        .container { display: flex; flex-wrap: wrap; gap: 25px; max-width: 1200px; margin: 0 auto; align-items: flex-start; }
        .left-panel { flex: 1; min-width: 340px; } 
        .right-panel { flex: 1.5; min-width: 360px; }
        @media (max-width: 850px) { .left-panel, .right-panel { flex: 100%; min-width: 100%; } }

        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card { 
            background: var(--card-bg); padding: 20px; 
            border-radius: 20px; margin-bottom: 20px; 
            box-shadow: 0 8px 20px rgba(255, 128, 171, 0.15); 
            border: 2px solid #fff; position: relative;
        }
        h3 { color: var(--primary-dark); margin-top: 0; border-bottom: 2px dashed #ffcdd2; padding-bottom: 10px; display: flex; align-items: center; gap: 8px; }

        /* è¡¨å•æ§ä»¶ */
        .input-row { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        input, select { padding: 10px; border: 2px solid #fce4ec; border-radius: 12px; flex: 1; outline: none; background: #fffbfb; }
        input:focus { border-color: var(--primary); }
        
        button { cursor: pointer; border: none; border-radius: 12px; font-weight: bold; padding: 10px 15px; transition: 0.2s; font-family: inherit; }
        button:active { transform: scale(0.95); }
        
        .btn-buy { background: linear-gradient(135deg, #a5d6a7, #66bb6a); color: white; width: 100%; }
        .btn-cook { background: linear-gradient(135deg, #ffcc80, #ffa726); color: white; width: 100%; font-size: 1.1em; padding: 12px; margin-top: 10px; }
        .btn-add { background: #f8bbd0; color: #880e4f; font-size: 0.8em; padding: 5px 12px; }
        .btn-del-mini { background: #ffcdd2; color: #c62828; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: 8px; flex-shrink: 0; }
        .btn-backup { background: linear-gradient(135deg, #81d4fa, #29b6f6); color: white; flex: 1; }
        .btn-restore { background: #e0f7fa; color: #0277bd; flex: 1; border: 2px dashed #29b6f6; }
        
        /* å†°ç®±åˆ—è¡¨æ ·å¼ */
        .stock-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; border-bottom: 1px dashed #fce4ec; }
        .ing-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; background: #fff8e1; padding: 8px; border-radius: 12px; flex-wrap: wrap; }
        .log-item { display: flex; justify-content: space-between; padding: 10px; background: #f3e5f5; margin-bottom: 8px; border-radius: 12px; font-size: 0.9em; }

        /* æ—¥å† */
        .calendar-header { display: flex; justify-content: space-between; margin-bottom: 15px; background: #fff0f5; padding: 12px; border-radius: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .day-cell { background: white; min-height: 100px; padding: 5px; border-radius: 15px; border: 2px solid #fce4ec; font-size: 0.9em; }
        .day-cell.today { border: 2px solid var(--primary); background: #fff8e1; }
        .dish-tag { display: block; padding: 3px 8px; margin-bottom: 4px; border-radius: 8px; font-size: 0.8em; color: white; text-shadow: 0 1px 0 rgba(0,0,0,0.1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .meal-breakfast { background: #90caf9; } .meal-lunch { background: #ffcc80; } .meal-dinner { background: #ce93d8; }

        /* === ğŸ§Š å¯è§†åŒ–å†°ç®± æ ¸å¿ƒæ ·å¼ === */
        .btn-visual { background: linear-gradient(135deg, #4fc3f7, #0288d1); color: white; width: 100%; margin-top: 10px; box-shadow: 0 4px 10px rgba(79, 195, 247, 0.3); }

        /* å†°ç®±å¼¹çª—è’™å±‚ */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 999; 
            display: none; justify-content: center; align-items: center; 
            backdrop-filter: blur(5px);
        }
        
        /* å†°ç®±ä¸»ä½“å®¹å™¨ */
        .fridge-modal { 
            width: 95%; max-width: 450px; height: 90vh; 
            background: white; border-radius: 25px; 
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .fridge-header { padding: 15px; background: #b3e5fc; display: flex; justify-content: space-between; align-items: center; }
        .fridge-header h3 { margin: 0; border: none; font-size: 1.1em; color: #01579b; }
        .btn-close { background: white; color: #01579b; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        .fridge-content { 
            flex: 1; overflow-y: auto; padding: 10px; background: #e1f5fe; 
            display: flex; flex-direction: column; gap: 15px;
        }

        /* å¾…æ•´ç†åŒº (è´­ç‰©è¢‹) */
        .grocery-bag { 
            background: #fff9c4; border: 2px dashed #fbc02d; 
            border-radius: 15px; padding: 10px; min-height: 60px;
            display: flex; flex-wrap: wrap; gap: 8px; align-content: flex-start;
        }
        .grocery-label { width: 100%; font-size: 0.8em; color: #f9a825; margin-bottom: 5px; text-align: center; }

        /* å†°ç®±ç»“æ„åŒº */
        .fridge-body { display: flex; flex-direction: column; gap: 10px; }
        
        /* é€šç”¨æ ¼å­æ ·å¼ */
        .zone { 
            background: rgba(255,255,255,0.7); border: 2px solid #81d4fa; 
            border-radius: 10px; min-height: 50px; position: relative;
            display: flex; flex-wrap: wrap; gap: 5px; padding: 5px;
            align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .zone.drag-over { background: #b3e5fc; border-color: #0288d1; box-shadow: inset 0 0 10px rgba(2,136,209,0.2); }
        .zone::before { 
            content: attr(data-label); position: absolute; top: 2px; left: 5px; 
            font-size: 0.6em; color: #81d4fa; pointer-events: none; 
        }

        /* ä¸Šå±‚ç»“æ„ */
        .top-section { border: 4px solid #b3e5fc; border-radius: 15px; padding: 5px; background: white; }
        .shelf { height: 60px; margin-bottom: 5px; border-bottom: 3px solid #e1f5fe; }
        .drawer-row { display: flex; gap: 5px; height: 70px; }
        .drawer { flex: 1; background: #f1f8e9; border-color: #a5d6a7; }

        /* ä¸‹å±‚ç»“æ„ */
        .bottom-section { display: flex; gap: 10px; height: 220px; }
        .bottom-col { flex: 1; border: 4px solid #b3e5fc; border-radius: 15px; padding: 5px; background: white; display: flex; flex-direction: column; gap: 5px; }
        .b-shelf { height: 50px; }
        .b-drawer { flex: 1; background: #e0f7fa; }

        /* é£Ÿææ–¹å— */
        .food-block { 
            background: white; border: 1px solid #ff80ab; 
            border-radius: 8px; padding: 4px 8px; 
            font-size: 0.8em; color: #880e4f;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            cursor: grab; user-select: none;
            z-index: 10; touch-action: none; /* å…³é”®ï¼šé˜²æ­¢æ‰‹æœºåŸç”Ÿæ»šåŠ¨å¹²æ‰°æ‹–æ‹½ */
            white-space: nowrap; max-width: 80px; overflow: hidden; text-overflow: ellipsis;
            animation: popIn 0.3s;
        }
        .food-block.dragging { opacity: 0.5; transform: scale(1.1); box-shadow: 0 10px 20px rgba(0,0,0,0.2); position: fixed; pointer-events: none; }
        .food-block.selected { background: #ff80ab; color: white; transform: scale(1.1); z-index: 100; border: 2px solid white; box-shadow: 0 0 0 2px #ff80ab; }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        
        .footer-status { text-align: center; color: var(--primary); font-size: 0.8em; margin-top: 30px; opacity: 0.6; }
    </style>
</head>
<body>

<div class="container">
    <div class="left-panel">
        <div class="card">
            <h3>ğŸ“ è¿›è´§å•¦</h3>
            <div class="input-row">
                <input type="text" id="buyName" placeholder="ä¹°äº†å¥½åƒçš„..." list="historyList" style="flex:2">
            </div>
            <div class="input-row">
                <input type="number" id="buyQty" placeholder="é‡" step="0.1">
                <select id="buyUnit" style="flex:0.8">
                    <option value="ä¸ª">ä¸ª</option> <option value="kg">kg</option> <option value="g">g</option>
                    <option value="åŒ…">åŒ…</option> <option value="ç“¶">ç“¶</option> <option value="ç›’">ç›’</option>
                </select>
                <button class="btn-buy" onclick="doBuy()" style="flex:0.8">å…¥åº“</button>
            </div>
            <datalist id="historyList"></datalist>
        </div>

        <div class="card" style="border: 3px solid var(--accent);">
            <h3>ğŸ¯ å°å¨æˆ¿</h3>
            <div class="input-row">
                <input type="date" id="cookDate">
                <select id="mealType">
                    <option value="breakfast">ğŸŒ¤ï¸ æ—©é¤</option> <option value="lunch" selected>â˜€ï¸ åˆé¤</option> <option value="dinner">ğŸŒ™ æ™šé¤</option>
                </select>
            </div>
            <div class="input-row"><input type="text" id="dishName" placeholder="æ–™ç†åå­—..."></div>
            <div style="display:flex; justify-content:space-between; margin:15px 0 5px 0;">
                <span style="color:#8d6e63; font-size:0.9em;">æ¶ˆè€—é£Ÿæ:</span>
                <button class="btn-add" onclick="addIngRow()">+ åŠ ä¸€é¡¹</button>
            </div>
            <div id="ingList"></div> 
            <button class="btn-cook" onclick="doCook()">ğŸ’– å¼€åŠ¨ï¼</button>
        </div>

        <div class="card">
            <h3>ğŸ§Š å†°ç®±å®åº“</h3>
            <div id="stockList" style="max-height:180px; overflow-y:auto;"></div>
            <button class="btn-visual" onclick="openFridge()">ğŸ§Š æ‰“å¼€å¯è§†å†°ç®± (æ‹–æ‹½æ•´ç†)</button>
        </div>

        <div class="card">
            <h3>ğŸ“’ æµæ°´è´¦</h3>
            <div id="mealLogList" style="max-height:150px; overflow-y:auto;"></div>
        </div>
        
        <div class="card" style="border: 2px dashed var(--safe);">
            <h3>ğŸ“‚ æ•°æ®å¤‡ä»½</h3>
            <div class="input-row">
                <button class="btn-backup" onclick="exportData()">â¬‡ï¸ å¤‡ä»½</button>
                <button class="btn-restore" onclick="document.getElementById('fileInput').click()">â¬†ï¸ æ¢å¤</button>
                <input type="file" id="fileInput" style="display:none" onchange="importData(this)">
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="card">
            <div class="calendar-header">
                <button onclick="moveMonth(-1)">â—€</button>
                <h3 id="monthTitle" style="margin:0; border:none; color:var(--text);">...</h3>
                <button onclick="moveMonth(1)">â–¶</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>
</div>

<div class="footer-status" id="systemStatus">æ­£åœ¨å¯åŠ¨ PWA... âœ¨</div>

<div class="modal-overlay" id="fridgeOverlay">
    <div class="fridge-modal">
        <div class="fridge-header">
            <h3>ğŸ§Š æ‹–æ‹½æ•´ç†é£Ÿæ</h3>
            <div class="btn-close" onclick="closeFridge()">Ã—</div>
        </div>
        <div class="fridge-content">
            <div class="grocery-bag" id="zone-unsorted">
                <div class="grocery-label">ğŸ›’ åˆšä¹°å›æ¥çš„ (ç‚¹æˆ‘æˆ–é•¿æŒ‰æ‹–èµ°)</div>
                </div>

            <div class="fridge-body">
                <div style="font-size:0.8em; color:#0288d1; text-align:center; margin-bottom:5px;">ğŸšª å†·è—å®¤ (ä¸Š)</div>
                <div class="top-section">
                    <div class="zone shelf" id="loc-t1" data-label="å±‚1"></div>
                    <div class="zone shelf" id="loc-t2" data-label="å±‚2"></div>
                    <div class="zone shelf" id="loc-t3" data-label="å±‚3"></div>
                    <div class="zone drawer" id="loc-t4" data-label="ä¿é²œæŠ½å±‰"></div>
                    <div class="drawer-row">
                        <div class="zone drawer" id="loc-t5l" data-label="å·¦æŠ½"></div>
                        <div class="zone drawer" id="loc-t5r" data-label="å³æŠ½"></div>
                    </div>
                </div>

                <div style="font-size:0.8em; color:#0288d1; text-align:center; margin:10px 0 5px 0;">â„ï¸ å†·å†»/å˜æ¸©å®¤ (ä¸‹)</div>
                <div class="bottom-section">
                    <div class="bottom-col">
                        <div class="zone b-shelf" id="loc-bl1" data-label="å·¦ä¸Š"></div>
                        <div class="zone b-drawer" id="loc-bl2" data-label="å·¦ä¸­"></div>
                        <div class="zone b-drawer" id="loc-bl3" data-label="å·¦ä¸‹"></div>
                    </div>
                    <div class="bottom-col">
                        <div class="zone b-shelf" id="loc-br1" data-label="å³ä¸Š"></div>
                        <div class="zone b-drawer" id="loc-br2" data-label="å³ä¸­"></div>
                        <div class="zone b-drawer" id="loc-br3" data-label="å³ä¸‹"></div>
                    </div>
                </div>
            </div>
        </div>
        <div style="padding:10px; text-align:center; background:#b3e5fc; color:#01579b; font-size:0.8em;">
            ğŸ’¡ æ‰‹æœºï¼šé•¿æŒ‰æ–¹å—æ‹–æ‹½ï¼Œæˆ–ç‚¹å‡»é€‰ä¸­å†ç‚¹æ ¼å­
        </div>
    </div>
</div>

<script>
    const KEY = 'food_v5_data'; 
    let data = { stock: {}, meals: [] };
    let curDate = new Date();
    // æ‹–æ‹½ç›¸å…³å˜é‡
    let selectedBlock = null; // ç‚¹å‡»é€‰ä¸­çš„
    let dragSrcEl = null;     // æ­£åœ¨æ‹–æ‹½çš„
    let longPressTimer = null; // é•¿æŒ‰è®¡æ—¶å™¨

    window.onload = function() {
        try {
            let saved = localStorage.getItem(KEY);
            if(saved) data = JSON.parse(saved);
            if(!data.stock) data.stock = {};
            if(!data.meals) data.meals = [];
        } catch(e) { console.log('Init'); }
        document.getElementById('cookDate').valueAsDate = new Date();
        addIngRow(); renderAll();
        document.getElementById('systemStatus').innerText = "âœ… V7.3 å†°ç®±å¯è§†ç‰ˆ | å®å®ä»Šå¤©åƒä»€ä¹ˆï¼Ÿ";
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    };

    function cuteAlert(msg) { alert(msg); }
    function getVal(id) { return document.getElementById(id).value; }
    function save() { localStorage.setItem(KEY, JSON.stringify(data)); }

    // === æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ===
    function doBuy() {
        let name = getVal('buyName'); let qty = parseFloat(getVal('buyQty')); let unit = getVal('buyUnit');
        if(!name) return cuteAlert("å¿˜è®°å†™åå­—å•¦ï¼");
        if(isNaN(qty) || qty <= 0) return cuteAlert("æ•°é‡ä¸å¯¹å“¦~");
        
        if(!data.stock[name]) data.stock[name] = {q:0, u:unit, loc:''}; // loc: '' è¡¨ç¤ºåœ¨å¾…æ•´ç†åŒº
        data.stock[name].q += qty; 
        data.stock[name].u = unit;
        
        save(); renderAll(); document.getElementById('buyQty').value = '';
        if(document.getElementById('fridgeOverlay').style.display === 'flex') renderFridgeBlocks(); // å¦‚æœå†°ç®±å¼€ç€å°±åˆ·æ–°
        cuteAlert(`âœ¨ å…¥åº“æˆåŠŸï¼å¿«å»å¯è§†å†°ç®±é‡ŒæŠŠå®ƒå½’ä½å§ï¼`);
    }

    function doCook() {
        let dish = getVal('dishName');
        if(!dish) return cuteAlert("æ–™ç†å«ä»€ä¹ˆåå­—å‘€ï¼Ÿ");
        let ings = [], rows = document.querySelectorAll('.ing-row');
        for(let row of rows) {
            let n = row.querySelector('.i-name').value.trim();
            let q = parseFloat(row.querySelector('.i-qty').value);
            let u = row.querySelector('.i-unit').value;
            if(n && q>0) ings.push({n, q, u});
        }
        ings.forEach(i => {
            if(!data.stock[i.n]) data.stock[i.n] = {q:0, u:i.u};
            data.stock[i.n].q -= i.q;
        });
        data.meals.push({ id: Date.now(), date: getVal('cookDate'), type: getVal('mealType'), name: dish, ings: ings });
        save(); renderAll();
        document.getElementById('dishName').value = ''; document.getElementById('ingList').innerHTML = ''; addIngRow();
        cuteAlert(`ğŸ½ï¸ è®°å½•å®Œæˆï¼è®°å¾—å»çœ‹çœ‹å†°ç®±æ˜¯ä¸æ˜¯å˜ç©ºäº†~`);
    }

    function deleteStock(name) {
        if(confirm(`ç¡®å®šåƒå…‰å…‰äº†å—ï¼š[${name}]ï¼Ÿ`)) { delete data.stock[name]; save(); renderAll(); renderFridgeBlocks(); }
    }
    function deleteMeal(id) {
        if(confirm(`åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ`)) { data.meals = data.meals.filter(m => m.id !== id); save(); renderAll(); }
    }

    // === æ¸²æŸ“é€»è¾‘ ===
    function renderAll() {
        // æ¸²æŸ“åº“å­˜åˆ—è¡¨
        let sList = document.getElementById('stockList'); sList.innerHTML = '';
        let sortedStock = Object.keys(data.stock).sort();
        if(sortedStock.length === 0) sList.innerHTML = '<div style="color:#d7ccc8; text-align:center;">ğŸ‘» å†°ç®±ç©ºç©ºå¦‚ä¹Ÿ</div>';
        sortedStock.forEach(k => {
            let item = data.stock[k];
            if(item.q !== 0) { 
                // æ˜¾ç¤ºå½“å‰ä½ç½®
                let locName = item.loc ? "âœ… å·²å½’ä½" : "ğŸ›’ å¾…æ•´ç†";
                sList.innerHTML += `<div class="stock-item">
                    <div><b>${k}</b> <span style="font-size:0.7em; color:#aaa;">(${locName})</span></div>
                    <div><span style="${item.q<0?'color:#ef9a9a':''}">${parseFloat(item.q.toFixed(2))} ${item.u}</span><button class="btn-del-mini" onclick="deleteStock('${k}')">Ã—</button></div>
                </div>`; 
            }
        });

        // æ¸²æŸ“æµæ°´è´¦ & ä¸‹æ‹‰åˆ—è¡¨ (ä¿æŒåŸæ ·)
        let mList = document.getElementById('mealLogList'); mList.innerHTML = '';
        [...data.meals].sort((a,b)=>b.id-a.id).slice(0,10).forEach(m => {
            let t={breakfast:'æ—©',lunch:'åˆ',dinner:'æ™š'};
            mList.innerHTML += `<div class="log-item"><div><span style="color:#aaa;">${m.date.slice(5)}</span> <span class="dish-tag meal-${m.type}">${t[m.type]}</span> ${m.name}</div><button class="btn-del-mini" onclick="deleteMeal(${m.id})">Ã—</button></div>`;
        });
        let dList = document.getElementById('historyList'); dList.innerHTML = '';
        Object.keys(data.stock).forEach(k => dList.innerHTML += `<option value="${k}">`);
        renderCalendar();
    }

    // === ğŸ§Š å¯è§†åŒ–å†°ç®±é€»è¾‘ ===
    function openFridge() {
        document.getElementById('fridgeOverlay').style.display = 'flex';
        renderFridgeBlocks();
    }
    function closeFridge() {
        document.getElementById('fridgeOverlay').style.display = 'none';
        renderAll(); // å…³é—­æ—¶åˆ·æ–°ä¸»åˆ—è¡¨
    }

    function renderFridgeBlocks() {
        // æ¸…ç©ºæ‰€æœ‰æ ¼å­
        document.querySelectorAll('.zone').forEach(z => z.innerHTML = '');
        document.getElementById('zone-unsorted').innerHTML = '<div class="grocery-label">ğŸ›’ åˆšä¹°å›æ¥çš„ (ç‚¹æˆ‘æˆ–é•¿æŒ‰æ‹–èµ°)</div>';

        Object.keys(data.stock).forEach(name => {
            let item = data.stock[name];
            if(item.q <= 0) return; // åƒå®Œçš„ä¸æ˜¾ç¤º

            let block = document.createElement('div');
            block.className = 'food-block';
            block.innerText = name;
            block.dataset.name = name; // å­˜åå­—
            
            // ç»‘å®šäº¤äº’äº‹ä»¶
            attachInteraction(block);

            // æ”¾å…¥å¯¹åº”ä½ç½®
            let targetId = item.loc || 'zone-unsorted';
            let targetZone = document.getElementById(targetId);
            if(targetZone) targetZone.appendChild(block);
            else document.getElementById('zone-unsorted').appendChild(block);
        });
    }

    // === ğŸ–ï¸ è§¦æ‘¸ä¸æ‹–æ‹½äº¤äº’å¼•æ“ (V2.0 æ··åˆæ¨¡å¼) ===
    function attachInteraction(el) {
        // æ¨¡å¼1ï¼šç‚¹å‡»é€‰ä¸­ (æœ€ç¨³å¦¥)
        el.onclick = function(e) {
            e.stopPropagation(); // é˜²æ­¢å†’æ³¡
            if(selectedBlock) selectedBlock.classList.remove('selected');
            selectedBlock = el;
            el.classList.add('selected');
        };

        // æ¨¡å¼2ï¼šé•¿æŒ‰æ‹–æ‹½ (æ‰‹æœºç«¯)
        el.ontouchstart = function(e) {
            longPressTimer = setTimeout(() => {
                startDrag(el, e.touches[0]);
            }, 300); // é•¿æŒ‰0.3ç§’è§¦å‘æ‹–æ‹½
        };
        el.ontouchend = function() { clearTimeout(longPressTimer); };
    }

    // å¤„ç†æ‹–æ‹½è¿‡ç¨‹
    let dragGhost = null;
    function startDrag(el, touch) {
        if(selectedBlock) { selectedBlock.classList.remove('selected'); selectedBlock = null; }
        
        // åˆ›å»ºåˆ†èº« (Ghost)
        dragGhost = el.cloneNode(true);
        dragGhost.classList.add('dragging');
        document.body.appendChild(dragGhost);
        
        moveGhost(touch.clientX, touch.clientY);

        // ç»‘å®šå…¨å±€ç§»åŠ¨äº‹ä»¶
        document.ontouchmove = function(e) {
            e.preventDefault(); // ç¦æ­¢å±å¹•æ»šåŠ¨
            moveGhost(e.touches[0].clientX, e.touches[0].clientY);
        };

        document.ontouchend = function(e) {
            let touch = e.changedTouches[0];
            // éšè—Ghostçœ‹ä¸€ä¸‹åº•ä¸‹æ˜¯å“ªä¸ªæ ¼å­
            dragGhost.style.display = 'none';
            let elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            dragGhost.remove();
            
            // æ‰¾æœ€è¿‘çš„ zone
            let zone = elemBelow ? elemBelow.closest('.zone') : null;
            if(!zone && elemBelow && elemBelow.closest('.grocery-bag')) zone = document.getElementById('zone-unsorted');

            if(zone) {
                // ç§»åŠ¨å…ƒç´ 
                zone.appendChild(el);
                updateItemLoc(el.dataset.name, zone.id);
            }
            
            // æ¸…ç†äº‹ä»¶
            document.ontouchmove = null;
            document.ontouchend = null;
        };
    }

    function moveGhost(x, y) {
        if(dragGhost) {
            dragGhost.style.left = (x - 40) + 'px';
            dragGhost.style.top = (y - 20) + 'px';
        }
    }

    // ç»‘å®šæ ¼å­çš„ç‚¹å‡»äº‹ä»¶ (é…åˆç‚¹å‡»é€‰ä¸­æ¨¡å¼)
    document.querySelectorAll('.zone, .grocery-bag').forEach(zone => {
        zone.onclick = function() {
            if(selectedBlock) {
                zone.appendChild(selectedBlock);
                updateItemLoc(selectedBlock.dataset.name, zone.id);
                selectedBlock.classList.remove('selected');
                selectedBlock = null;
            }
        }
    });

    function updateItemLoc(name, locId) {
        if(locId === 'zone-unsorted') locId = '';
        if(data.stock[name]) {
            data.stock[name].loc = locId;
            save();
        }
    }

    // åŸæœ‰çš„è¾…åŠ©å‡½æ•°
    function addIngRow() {
        let d = document.createElement('div'); d.className='ing-row';
        d.innerHTML = `<input class="i-name" placeholder="é£Ÿæå" list="historyList" onchange="fillUnit(this)" style="flex:1.5"><input type="number" class="i-qty" placeholder="é‡" style="flex:0.8"><input class="i-unit" placeholder="å•ä½" style="flex:0.6" readonly><button class="btn-del-mini" onclick="this.parentElement.remove()" style="background:#ef9a9a;color:white">Ã—</button>`;
        document.getElementById('ingList').appendChild(d);
    }
    function fillUnit(i) { if(data.stock[i.value]) i.parentElement.querySelector('.i-unit').value = data.stock[i.value].u; }
    function renderCalendar() { /* ä¿æŒåŸæ ·ç®€åŒ–ç‰ˆ */
        let y = curDate.getFullYear(), m = curDate.getMonth();
        document.getElementById('monthTitle').innerText = `${y}å¹´ ${m+1}æœˆ`;
        let grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
        let days = new Date(y, m+1, 0).getDate();
        let first = new Date(y, m, 1).getDay();
        for(let i=0;i<first;i++) grid.innerHTML+=`<div></div>`;
        for(let d=1; d<=days; d++) {
            let dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            let isToday = dStr === new Date().toISOString().split('T')[0];
            let hasMeal = data.meals.some(x=>x.date===dStr);
            grid.innerHTML += `<div class="day-cell ${isToday?'today':''}" style="min-height:40px;display:flex;justify-content:center;align-items:center;">${d}${hasMeal?'<span style="color:var(--primary)">â˜…</span>':''}</div>`;
        }
    }
    function moveMonth(n) { curDate.setMonth(curDate.getMonth()+n); renderCalendar(); }
</script>
</body>
</html>
