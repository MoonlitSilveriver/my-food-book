<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>566ä»Šå¤©åƒä»€ä¹ˆ</title>
    
    <link rel="manifest" href="manifest.json?v=888">
    <meta name="theme-color" content="#fff0f5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å®å®æ‰‹å¸">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        /* === ğŸ¬ è°ƒè‰²ç›˜ (V7.1 åŸç‰ˆ) === */
        :root { 
            --primary: #ff80ab; --primary-dark: #f06292;
            --bg-color: #fff0f5; --card-bg: #ffffff;
            --text: #5d4037; --accent: #ffb74d; --danger: #ef9a9a;
            --safe: #4fc3f7;
        }

        body { 
            font-family: "YouYuan", "Microsoft YaHei", "Segoe UI", sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#f8bbd0 2px, transparent 2px);
            background-size: 20px 20px;
            color: var(--text); margin: 0; padding: 20px; 
            min-height: 100vh; 
            /* é˜²æ­¢æ‰‹æœºç«¯å·¦å³æ™ƒåŠ¨ */
            overflow-x: hidden; 
            -webkit-tap-highlight-color: transparent;
        }
        
        /* å¸ƒå±€å®¹å™¨ */
        .container { display: flex; flex-wrap: wrap; gap: 25px; max-width: 1200px; margin: 0 auto; align-items: flex-start; }
        .left-panel { flex: 1; min-width: 340px; } 
        .right-panel { flex: 1.5; min-width: 360px; }
        @media (max-width: 850px) { .left-panel, .right-panel { flex: 100%; min-width: 100%; } }

        /* å¡ç‰‡ */
        .card { 
            background: var(--card-bg); padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 8px 20px rgba(255, 128, 171, 0.15); 
            margin-bottom: 20px; border: 2px solid #fff;
            position: relative;
        }
        
        h3 { 
            color: var(--primary-dark); margin-top: 0; 
            border-bottom: 2px dashed #ffcdd2; 
            padding-bottom: 10px; font-size: 1.2em; 
            display: flex; align-items: center; gap: 8px;
        }

        /* è¾“å…¥æ¡† */
        .input-row { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        input, select { 
            padding: 10px; border: 2px solid #fce4ec; border-radius: 12px; 
            flex: 1; outline: none; color: var(--text); transition: 0.3s;
            min-width: 60px; background: #fffbfb;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(255, 128, 171, 0.2); }

        /* æŒ‰é’® */
        button { cursor: pointer; border: none; border-radius: 12px; font-weight: bold; transition: 0.2s; padding: 10px 15px; font-family: inherit; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .btn-buy { background: linear-gradient(135deg, #a5d6a7, #66bb6a); color: white; width: 100%; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
        .btn-cook { background: linear-gradient(135deg, #ffcc80, #ffa726); color: white; width: 100%; font-size: 1.1em; padding: 12px; margin-top: 10px; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
        .btn-add { background: #f8bbd0; color: #880e4f; font-size: 0.8em; padding: 5px 12px; }
        .btn-del-mini { background: #ffcdd2; color: #c62828; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: 8px; flex-shrink: 0; box-shadow: 1px 1px 3px rgba(0,0,0,0.1); }

        .btn-backup { background: linear-gradient(135deg, #81d4fa, #29b6f6); color: white; flex: 1; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
        .btn-restore { background: #e0f7fa; color: #0277bd; flex: 1; border: 2px dashed #29b6f6; }

        .ing-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; background: #fff8e1; padding: 8px; border-radius: 12px; flex-wrap: wrap; }
        .stock-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; border-bottom: 1px dashed #fce4ec; color: #6d4c41; }
        .log-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f3e5f5; margin-bottom: 8px; border-radius: 12px; font-size: 0.9em; }

        /* æ—¥å† */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #fff0f5; padding: 12px; border-radius: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .day-cell { background: white; min-height: 100px; padding: 5px; border-radius: 15px; border: 2px solid #fce4ec; font-size: 0.9em; transition: 0.2s; }
        .day-cell:hover { border-color: var(--primary); transform: scale(1.02); }
        .day-cell.today { border: 2px solid var(--primary); background: #fff8e1; position: relative; }
        .day-cell.today::after { content: "â¤ï¸"; position: absolute; top: 2px; right: 5px; font-size: 12px; }
        .day-num { font-weight: bold; color: #d7ccc8; margin-bottom: 5px; font-family: sans-serif; }
        .day-cell.today .day-num { color: var(--primary); }
        
        .dish-tag { display: block; padding: 3px 8px; margin-bottom: 4px; border-radius: 8px; font-size: 0.8em; cursor: help; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white; text-shadow: 0 1px 0 rgba(0,0,0,0.1); }
        .meal-breakfast { background: #90caf9; } .meal-lunch { background: #ffcc80; } .meal-dinner { background: #ce93d8; }

        .footer-status { text-align: center; color: var(--primary); font-size: 0.8em; margin-top: 30px; padding-bottom: 20px; opacity: 0.6; }
    </style>
</head>
<body>

<div class="container">
    <div class="left-panel">
        
        <div class="card">
            <h3>ğŸ“ è¿›è´§å•¦ <span style="font-size:0.6em; color:#aaa; font-weight:normal; margin-left:auto;">(è®°å¾—å¡«å•ä½å“¦)</span></h3>
            <div class="input-row">
                <input type="text" id="buyName" placeholder="ä¹°äº†å¥½åƒçš„..." list="historyList" style="flex:2">
            </div>
            <div class="input-row">
                <input type="number" id="buyQty" placeholder="å¤šå°‘?" step="0.1">
                <select id="buyUnit" style="flex:0.8">
                    <option value="ä¸ª">ä¸ª</option> <option value="kg">kg</option> <option value="g">g</option>
                    <option value="åŒ…">åŒ…</option> <option value="ç“¶">ç“¶</option> <option value="ç›’">ç›’</option> <option value="æŠŠ">æŠŠ</option>
                </select>
                <button class="btn-buy" onclick="doBuy()" style="flex:0.8">âœ¨ å…¥åº“</button>
            </div>
            <datalist id="historyList"></datalist>
        </div>

        <div class="card" style="border: 3px solid var(--accent);">
            <h3>ğŸ¯ å°å¨æˆ¿ <span style="font-size:0.6em; color:#aaa; font-weight:normal; margin-left:auto;">(ä»Šå¤©æ°ä»€ä¹ˆ?)</span></h3>
            <div class="input-row">
                <input type="date" id="cookDate">
                <select id="mealType">
                    <option value="breakfast">ğŸŒ¤ï¸ æ—©é¤</option> <option value="lunch" selected>â˜€ï¸ åˆé¤</option> <option value="dinner">ğŸŒ™ æ™šé¤</option>
                </select>
            </div>
            <div class="input-row">
                <input type="text" id="dishName" placeholder="æ¯”å¦‚: è±ªåæ³¡é¢ ğŸœ">
            </div>
            <div style="display:flex; justify-content:space-between; margin:15px 0 5px 0;">
                <span style="color:#8d6e63; font-size:0.9em;">ğŸ§‚ æ¶ˆè€—äº†å“ªäº›é£Ÿæå‘€:</span>
                <button class="btn-add" onclick="addIngRow()">+ åŠ ä¸€é¡¹</button>
            </div>
            <div id="ingList"></div> 
            <button class="btn-cook" onclick="doCook()">ğŸ’– åšå¥½å•¦ï¼Œå¼€åŠ¨ï¼</button>
        </div>

        <div class="card">
            <h3>ğŸ§Š å†°ç®±å®åº“</h3>
            <div id="stockList" style="max-height:180px; overflow-y:auto;"></div>
            <div style="text-align:center; margin-top:10px; font-size:0.8em; color:#d7ccc8;">(ç‚¹ç²‰è‰²å°å‰å‰å°±èƒ½åƒå…‰å…‰/åˆ é™¤å“¦)</div>
        </div>

        <div class="card">
            <h3>ğŸ“’ ç¢ç¢å¿µæµæ°´è´¦</h3>
            <div id="mealLogList" style="max-height:150px; overflow-y:auto;"></div>
        </div>

        <div class="card" style="border: 2px dashed var(--safe);">
            <h3>ğŸ“‚ æ•°æ®ä¿é™©ç®± <span style="font-size:0.6em; color:#aaa; font-weight:normal; margin-left:auto;">(æ¬å®¶/å¤‡ä»½ç”¨è¿™é‡Œ)</span></h3>
            <div class="input-row">
                <button class="btn-backup" onclick="exportData()">â¬‡ï¸ å¤‡ä»½/å¯¼å‡ºæ•°æ®</button>
                <button class="btn-restore" onclick="document.getElementById('fileInput').click()">â¬†ï¸ æ¢å¤/å¯¼å…¥æ•°æ®</button>
                <input type="file" id="fileInput" style="display:none" onchange="importData(this)">
            </div>
            <div style="font-size:0.8em; color:#90a4ae;">
                * ç”µè„‘ç‚¹â€œå¤‡ä»½â€å‘ç»™æ‰‹æœºï¼Œæ‰‹æœºç‚¹â€œæ¢å¤â€å°±èƒ½åŒæ­¥å•¦ï¼
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="card">
            <div class="calendar-header">
                <button onclick="moveMonth(-1)">â—€ ä¸Šæœˆ</button>
                <h3 id="monthTitle" style="margin:0; border:none; color:var(--text);">...</h3>
                <button onclick="moveMonth(1)">ä¸‹æœˆ â–¶</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>
</div>

<div class="footer-status" id="systemStatus">æ­£åœ¨å¯åŠ¨ PWA å¼•æ“... âœ¨</div>

<script>
    // === V7.1 åŸæœ‰é€»è¾‘ (å®Œå…¨ä¿ç•™) ===
    const KEY = 'food_v5_data'; 
    let data = { stock: {}, meals: [] };
    let curDate = new Date();

    window.onload = function() {
        try {
            let saved = localStorage.getItem(KEY);
            if(saved) data = JSON.parse(saved);
            if(!data.stock) data.stock = {};
            if(!data.meals) data.meals = [];
        } catch(e) { console.log('Init'); }
        document.getElementById('cookDate').valueAsDate = new Date();
        addIngRow(); renderAll();
        document.getElementById('systemStatus').innerText = "âœ… V7.2 PWAç‰ˆ | å®å®å¤§äººä»Šå¤©åƒä»€ä¹ˆï¼Ÿ";
        
        // PWA æ³¨å†Œä»£ç 
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('PWA Service Worker æ³¨å†ŒæˆåŠŸ', reg))
                .catch(err => console.log('PWA æ³¨å†Œå¤±è´¥', err));
        }
    };

    function cuteAlert(msg) { alert(msg); }
    function doBuy() {
        let name = getVal('buyName'); let qty = parseFloat(getVal('buyQty')); let unit = getVal('buyUnit');
        if(!name) return cuteAlert("å“å‘€ï¼Œå¥½åƒå¿˜è®°å†™æ˜¯ä»€ä¹ˆå¥½åƒçš„äº†ï¼(ï¼ï¹ï¼œ)");
        if(isNaN(qty) || qty <= 0) return cuteAlert("æ•°é‡ä¸å¯¹å“¦ï¼Œä¸å¯ä»¥æ˜¯ç©ºæ°”å‘¢~ (qwq)");
        if(!data.stock[name]) data.stock[name] = {q:0, u:unit};
        data.stock[name].q += qty; data.stock[name].u = unit;
        save(); renderAll(); document.getElementById('buyQty').value = '';
        cuteAlert(`âœ¨ æˆåŠŸï¼å†°ç®±é‡Œå¤šäº† ${qty}${unit} [${name}]ï¼(â‰§âˆ‡â‰¦)ï¾‰`);
    }
    function doCook() {
        let dish = getVal('dishName');
        if(!dish) return cuteAlert("è¿™é“ç¾å‘³çš„æ–™ç†å«ä»€ä¹ˆåå­—å‘€ï¼Ÿ(O_O)?");
        let ings = [], rows = document.querySelectorAll('.ing-row');
        for(let row of rows) {
            let n = row.querySelector('.i-name').value.trim();
            let q = parseFloat(row.querySelector('.i-qty').value);
            let u = row.querySelector('.i-unit').value;
            if(n && q>0) ings.push({n, q, u});
        }
        ings.forEach(i => {
            if(!data.stock[i.n]) data.stock[i.n] = {q:0, u:i.u};
            data.stock[i.n].q -= i.q;
        });
        data.meals.push({ id: Date.now(), date: getVal('cookDate'), type: getVal('mealType'), name: dish, ings: ings });
        save(); renderAll();
        document.getElementById('dishName').value = ''; document.getElementById('ingList').innerHTML = ''; addIngRow();
        cuteAlert(`ğŸ½ï¸ è®°å½•å¥½å•¦ï¼[${dish}] ä¸€å®šå¾ˆå¥½åƒå§~ å¸æºœ (*^â–½^*)`);
    }
    function deleteStock(name) {
        if(confirm(`(ãƒ»_ãƒ») ç¡®å®šè¦æŠŠå†°ç®±é‡Œçš„ [${name}] å…¨éƒ¨æ¸…ç©ºå—ï¼Ÿ`)) { delete data.stock[name]; save(); renderAll(); }
    }
    function deleteMeal(id) {
        if(confirm(`(qwq) ç¡®å®šè¦æ“¦æ‰è¿™æ¡ç”¨é¤è®°å½•å—ï¼Ÿ`)) { data.meals = data.meals.filter(m => m.id !== id); save(); renderAll(); }
    }
    function exportData() {
        const jsonStr = JSON.stringify(data);
        const blob = new Blob([jsonStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url;
        const date = new Date().toISOString().slice(0,10);
        a.download = `å®å®é¥®é£Ÿå¤‡ä»½_${date}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        cuteAlert("ğŸ“¦ æ•°æ®å·²æ‰“åŒ…å¸¦èµ°å•¦ï¼è¯·æ”¶å¥½å“¦ (ï¾‰>Ï‰<)ï¾‰");
    }
    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        if(!confirm("âš ï¸ è­¦å‘Šï¼šå¯¼å…¥æ•°æ®ä¼šè¦†ç›–å½“å‰çš„è®°å½•å“¦ï¼\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ(Â°ãƒ¼Â°ã€ƒ)")) { input.value = ''; return; }
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const newData = JSON.parse(e.target.result);
                if(newData.stock && newData.meals) { data = newData; save(); renderAll(); cuteAlert("ğŸ‰ æ•°æ®æ¢å¤æˆåŠŸï¼æ¬¢è¿å›å®¶~ (*^â–½^*)"); } 
                else { cuteAlert("æ–‡ä»¶æ ¼å¼å¥½åƒä¸å¯¹å“¦... (O_O)?"); }
            } catch(err) { cuteAlert("è¯»å–å¤±è´¥å•¦ï¼Œæ˜¯ä¸æ˜¯æ‹¿é”™æ–‡ä»¶äº†ï¼Ÿ"); }
        };
        reader.readAsText(file);
    }
    function renderAll() {
        let sList = document.getElementById('stockList'); sList.innerHTML = '';
        let sortedStock = Object.keys(data.stock).sort();
        if(sortedStock.length === 0) sList.innerHTML = '<div style="color:#d7ccc8; text-align:center; padding:10px;">ğŸ‘» å†°ç®±ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»è¿›è´§å§~</div>';
        sortedStock.forEach(k => {
            let item = data.stock[k];
            if(item.q !== 0) { sList.innerHTML += `<div class="stock-item"><span><b>${k}</b></span><div style="display:flex; align-items:center;"><span style="${item.q<0?'color:#ef9a9a':''}">${parseFloat(item.q.toFixed(2))} ${item.u}</span><button class="btn-del-mini" onclick="deleteStock('${k}')">Ã—</button></div></div>`; }
        });
        let mList = document.getElementById('mealLogList'); mList.innerHTML = '';
        let recentMeals = [...data.meals].sort((a,b)=>b.id-a.id).slice(0,10);
        if(recentMeals.length === 0) mList.innerHTML = '<div style="color:#d7ccc8; text-align:center; padding:10px;">è¿˜æ²¡å¼€å§‹è®°å½•å‘¢ï¼ŒæœŸå¾…å®å®å¤§äººçš„ç¾é£Ÿ~</div>';
        recentMeals.forEach(m => {
            let t={breakfast:'æ—©',lunch:'åˆ',dinner:'æ™š'};
            mList.innerHTML += `<div class="log-item"><div style="display:flex;gap:8px;align-items:center;"><span style="color:#aaa;font-size:0.8em">${m.date.slice(5)}</span> <span class="dish-tag meal-${m.type}" style="margin:0">${t[m.type]}</span> ${m.name}</div><button class="btn-del-mini" onclick="deleteMeal(${m.id})">Ã—</button></div>`;
        });
        let dList = document.getElementById('historyList'); dList.innerHTML = '';
        Object.keys(data.stock).forEach(k => dList.innerHTML += `<option value="${k}">`);
        renderCalendar();
    }
    function renderCalendar() {
        let y = curDate.getFullYear(), m = curDate.getMonth();
        document.getElementById('monthTitle').innerText = `${y}å¹´ ${m+1}æœˆ`;
        let grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
        let firstDay = new Date(y, m, 1).getDay();
        let daysInMonth = new Date(y, m+1, 0).getDate();
        ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(d => grid.innerHTML+=`<div style="text-align:center;color:#bcaaa4;font-size:0.8em">${d}</div>`);
        for(let i=0; i<firstDay; i++) grid.innerHTML+=`<div></div>`;
        for(let d=1; d<=daysInMonth; d++) {
            let dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            let isToday = dStr === new Date().toISOString().split('T')[0];
            let meals = data.meals.filter(x => x.date === dStr);
            let html = meals.map(x => {
                let tips = x.ings.map(i=>`${i.n}${i.q}`).join(',');
                if(tips === "") tips = "æ²¡è®°å½•é£Ÿææ¶ˆè€—å“¦T^T";
                return `<span class="dish-tag meal-${x.type}" title="${tips}">${x.name}</span>`;
            }).join('');
            grid.innerHTML += `<div class="day-cell ${isToday?'today':''}"><div class="day-num">${d}</div><div style="overflow-y:auto;height:70px">${html}</div></div>`;
        }
    }
    function addIngRow() {
        let d = document.createElement('div'); d.className='ing-row';
        d.innerHTML = `<input class="i-name" placeholder="é£Ÿæå" list="historyList" onchange="fillUnit(this)" style="flex:1.5"><input type="number" class="i-qty" placeholder="é‡" style="flex:0.8"><input class="i-unit" placeholder="å•ä½" style="flex:0.6" readonly><button class="btn-del-mini" onclick="this.parentElement.remove()" style="background:#ef9a9a;color:white">Ã—</button>`;
        document.getElementById('ingList').appendChild(d);
    }
    function fillUnit(i) { if(data.stock[i.value]) i.parentElement.querySelector('.i-unit').value = data.stock[i.value].u; }
    function moveMonth(n) { curDate.setMonth(curDate.getMonth()+n); renderAll(); }
    function getVal(id) { return document.getElementById(id).value; }
    function save() { localStorage.setItem(KEY, JSON.stringify(data)); }
</script>
</body>

</html>


